<!DOCTYPE html>
<!--
 Luigi shell file for standalone frontend development without full Python backend with statically provided data
 call with the param config with the name of the configuration file or just the number if the file is following the convention nnn-app.config.js
 e.g. http://localhost:8080/?config=005
 -->
<html>
  <head>
    <title>Workspace-App</title>
    <base href="/">
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"
    />
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.css"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script src="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.js"></script>
    <script type="module">
      const STORAGE_KEY = "app.config";

      const params = new URLSearchParams(location.search);
      let configName = params.get("config");

      if (configName) {
        // Normalize numeric config values
        if (/^\d+$/.test(configName)) {
          configName = `${configName}-app-config.js`;
        }

        // Persist explicitly provided config
        sessionStorage.setItem(STORAGE_KEY, configName);
      } else {
        // Fallback to previously stored config
        configName = sessionStorage.getItem(STORAGE_KEY) || "app-config.js";
      }

      // simple allow-list
      if (!/^[\w.-]+\.js$/.test(configName)) {
        console.error("Invalid config filename:", configName);
        throw new Error("Invalid config filename");
      }

      // Load Config (ES-Module)
      let mod;
      try {
        mod = await import(`/config/${configName}`);
        console.log("Loaded config module:", configName);
      } catch (e) {
        console.error("Failed to load config:", configName, e);
        // fallback
        mod = { workspaceData: { name: "Fallback" }, endpointsData: [] };
      }

      const request = '{{ request | safe }}';
      // const workspaceData = '{{ workspace_data | safe }}';
      // const endpointsData = '{{ endpoints_data | safe }}';
      const frontendUrl = 'http://localhost:9000/'; // '{{ frontend_url | safe }}';

      function decodeData(base64String) {
          return base64String;
      }

      function hasAnyManagePermission(permissions) {
        if (!Array.isArray(permissions)) {
          return false;
        }

        return permissions.some(p => typeof p === 'string' && p.startsWith('MANAGE_'));
      }

      const workspace = decodeData(mod.workspaceData);
      console.log(workspace)
      const endpoints = Array.isArray(decodeData(mod.endpointsData)) ? decodeData(mod.endpointsData) : [];
      const user = workspace?.user || { name: 'unknown'};
      const isAdmin = hasAnyManagePermission(user?.permissions)
      let children = []
      if (isAdmin) {
        children.push(
                {
                  pathSegment: 'management',
                  label: 'Management',
                  icon: 'action-settings',
                  viewUrl: frontendUrl + '#/management'
                })
      }

      endpoints.forEach(endpoint => {
        if (endpoint && typeof endpoint.id === 'string' && typeof endpoint.url === 'string') {
          let targetUrl = endpoint.url;
          if (targetUrl && !targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
            targetUrl = 'https://' + targetUrl;
          } else if (!targetUrl) {
            targetUrl = '#';
          }

          children.push({
            category: { label: 'Links', icon: 'link' },
            label: endpoint.id,
            externalLink: { url: targetUrl }
          });
        }
      });

      const luigiConfig = {
        navigation: {
          profile: {
            staticUserInfoFn: () => ({
              name: user.name,
              // email: 'email'
            })
          },
          nodes: () => [
            {
              pathSegment: 'home',
              label: workspace.name,
              icon: 'home',
              viewUrl: frontendUrl + '#/home',
              children: children,
              context: {
                workspace: workspace
              }
            }
          ]
        },
        routing: {
          useHashRouting: true
        },
        settings: {
          header: {
            title: `Workspace: ${workspace.name} /  User: ${user.name}`,
            logo: '/logo.svg',
            profile: {
              name: user.name,
              items: []
            }
          },
          // profileType: 'Fiori3',
          hideNavigation: (children.length === 0),
          responsiveNavigation: 'semiCollapsible'
        }
      };

      Luigi.setConfig(luigiConfig);
    </script>
  </body>
</html>
