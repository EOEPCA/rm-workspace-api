<!DOCTYPE html>
<!--
 Luigi shell file for standalone frontend development without full Python backend with statically provided data
 -->
<html>
  <head>
    <title>Workspace-App</title>
    <base href="/">
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"
    />
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.css"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script src="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.js"></script>
    <script type="module">
      const params = new URLSearchParams(location.search);
      let configName = params.get("config") || "app-config.js";

      if (/^\d+$/.test(configName)) {
        configName = `${configName}-app-config.js`;
      }

      // simple allow-list
      if (!/^[\w.-]+\.js$/.test(configName)) {
        console.error("Invalid config filename:", configName);
        throw new Error("Invalid config filename");
      }

      // Load Config (ES-Module)
      let mod;
      try {
        mod = await import(`/config/${configName}`);
        console.log("Loaded config module:", configName);
      } catch (e) {
        console.error("Failed to load config:", configName, e);
        // fallback
        mod = { workspaceData: { name: "Fallback" }, endpointsData: [] };
      }

      const request = '{{ request | safe }}';
      // const workspaceData = '{{ workspace_data | safe }}';
      // const endpointsData = '{{ endpoints_data | safe }}';
      const frontendUrl = 'http://localhost:9000/'; // '{{ frontend_url | safe }}';

      function decodeData(base64String) {
          return base64String;
      }

      const workspace = decodeData(mod.workspaceData);
      const endpoints = Array.isArray(decodeData(mod.endpointsData)) ? decodeData(mod.endpointsData) : [];
      let children = [
        {
          pathSegment: 'management',
          label: 'Management',
          icon: 'action-settings',
          viewUrl: frontendUrl + '#/management'
        }
      ];

      endpoints.forEach(endpoint => {
        if (endpoint && typeof endpoint.id === 'string' && typeof endpoint.url === 'string') {
          let targetUrl = endpoint.url;
          if (targetUrl && !targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
            targetUrl = 'https://' + targetUrl;
          } else if (!targetUrl) {
            targetUrl = '#';
          }

          children.push({
            category: { label: 'Links', icon: 'link' },
            label: endpoint.id,
            externalLink: { url: targetUrl }
          });
        }
      });

      const luigiConfig = {
        navigation: {
          nodes: () => [
            {
              pathSegment: 'home',
              label: workspace.name,
              icon: 'home',
              viewUrl: frontendUrl + '#/home',
              children: children,
              context: {
                workspace: workspace
              }
            }
          ]
        },
        routing: {
          useHashRouting: true
        },
        settings: {
          header: {
            title: `Workspace: ${workspace.name}`,
            logo: '/logo.svg',
            profile: false
          },
          responsiveNavigation: 'semiCollapsible'
        }
      };

      Luigi.setConfig(luigiConfig);
    </script>
  </body>
</html>
