<!DOCTYPE html>
<html>
  <head>
    <title>Workspace-App</title>
    <base href="{{ base_path.rstrip('/') }}/">
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"
    />
    <link rel="icon" href="/ui/icons/favicon.ico" type="image/x-icon">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.css"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script src="https://cdn.jsdelivr.net/npm/@luigi-project/core@latest/luigi.js"></script>
    <script>
      const request = '{{ request | safe }}';
      const workspaceData = '{{ workspace_data | safe }}';
      const endpointsData = '{{ endpoints_data | safe }}';
      const frontendUrl = '{{ frontend_url | safe }}';

      function decodeData(base64String) {
        try {
          if (base64String && base64String.trim() !== '') {
            return JSON.parse(atob(base64String));
          }
        } catch (e) {
          console.warn('Failed to decode data', e);
        }
        return null;
      }

      function hasAnyManagePermission(permissions) {
        if (!Array.isArray(permissions)) {
          return false;
        }

        return permissions.some(p => typeof p === 'string' && p.startsWith('MANAGE_'));
      }

      const workspace = decodeData(workspaceData);
      console.log(workspace)
      const endpoints = Array.isArray(decodeData(endpointsData)) ? decodeData(endpointsData) : [];
      const user = workspace?.user || { name: 'unknown'};
      const isAdmin = hasAnyManagePermission(user?.permissions)
      let children = []
      if (!isAdmin) {
        children.push(
                {
                  pathSegment: 'management',
                  label: 'Management',
                  icon: 'action-settings',
                  viewUrl: frontendUrl + '#/management'
                })
      }

      endpoints.forEach(endpoint => {
        if (endpoint && typeof endpoint.id === 'string' && typeof endpoint.url === 'string') {
          let targetUrl = endpoint.url;
          if (targetUrl && !targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
            targetUrl = 'https://' + targetUrl;
          } else if (!targetUrl) {
            targetUrl = '#';
          }

          children.push({
            category: { label: 'Links', icon: 'link' },
            label: endpoint.id,
            externalLink: { url: targetUrl }
          });
        }
      });

      const luigiConfig = {
        navigation: {
          profile: {
            staticUserInfoFn: () => ({
              name: user.name,
              // email: 'email'
            })
          },
          nodes: () => [
            {
              pathSegment: 'home',
              label: workspace.name,
              icon: 'home',
              viewUrl: frontendUrl + '/',
              children: children,
              context: {
                workspace: workspace
              }
            }
          ]
        },
        routing: {
          useHashRouting: true
        },
        settings: {
          header: {
            title: `Workspace: ${workspace.name} /  User: ${user.name}`,
            logo: '/ui/logo.svg'
          },
          hideNavigation: (children.length === 0),
          responsiveNavigation: 'semiCollapsible'
        }
      };

      Luigi.setConfig(luigiConfig);
    </script>
  </body>
</html>
